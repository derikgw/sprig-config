# ==========================================
#  GitLab CI for sprig-config
# ==========================================
# Runs lint, tests, security scans, and
# allows a manual publish to GitLab PyPI
# from the main branch.
# ==========================================

stages:
  - lint
  - test
  - security
  - deploy
  - pages

variables:
  POETRY_VERSION: "2.2.0"
  PIP_NO_CACHE_DIR: "1"
  PIP_DISABLE_PIP_VERSION_CHECK: "1"
  POETRY_NO_INTERACTION: "1"
  POETRY_VIRTUALENVS_CREATE: "true"
  POETRY_VIRTUALENVS_IN_PROJECT: "true"
  PYTHON_KEYRING_BACKEND: "keyring.backends.null.Keyring"
  SECRET_DETECTION_ENABLED: "true"
  SAST_STAGE: security
  SECRET_DETECTION_STAGE: security
  POETRY_HTTP_BASIC_GITLAB_PYPI_USERNAME: "__token__"
  POETRY_HTTP_BASIC_GITLAB_PYPI_PASSWORD: "${GITLAB_PYPI_TOKEN}"
  PIPELINE_LABEL: "Unknown pipeline"

.default_setup:
  image: python:3.13-slim
  before_script:
    - cd sprig-config-module
    - pip install --no-cache-dir "poetry==$POETRY_VERSION"
    - poetry install --no-ansi

workflow:
  rules:
    - if: '$CI_PIPELINE_SOURCE == "schedule"'
      when: always
      variables:
        PIPELINE_LABEL: "Daily Vulnerability Scan"
    - if: '$CI_COMMIT_TAG'
      when: always
      variables:
        PIPELINE_LABEL: "Commit Tag Pipeline"
    - if: '$CI_COMMIT_BRANCH'
      when: always
      variables:
        PIPELINE_LABEL: "Commit Pipeline"

lint:
  stage: lint
  extends: .default_setup
  script:
    - poetry run ruff check src
  artifacts:
    when: always
    paths:
      - sprig-config-module/ruff.log
  rules:
    - if: '$CI_PIPELINE_SOURCE == "schedule"'
      when: never
    - when: always

pytest:
  stage: test
  extends: .default_setup
  variables:
    APP_SECRET_KEY: "Y1PvJOeB_Dhak0oNJecfKRaKb4VcvmTwlFUo8-gVr7Q="  # Key for test only
  script:
    - poetry run pytest --maxfail=1 --disable-warnings -q --cov=src --cov-report=xml
  artifacts:
    when: always
    reports:
      coverage_report:
        coverage_format: cobertura
        path: sprig-config-module/coverage.xml
    paths:
      - sprig-config-module/coverage.xml
  rules:
    - if: '$CI_PIPELINE_SOURCE == "schedule"'
      when: never
    - when: always

include:
  - template: Security/SAST.gitlab-ci.yml
  - template: Security/Secret-Detection.gitlab-ci.yml

sast:
  stage: security

secret_detection:
  stage: security

# pip-audit - Python dependency vulnerability scanning
pip_audit:
  stage: security
  extends: .default_setup
  allow_failure: true
  script:
    - pip install pip-audit
    - pip-audit --format json --output pip-audit-report.json || true
    - pip-audit --format markdown --output pip-audit-report.md || true
    - pip-audit  # Human-readable output
    - echo "Files generated:" && ls -la *.json *.md 2>/dev/null || true
  after_script:
    - |
      # Create GitLab issue if vulnerabilities found during scheduled scans
      if [ "$CI_PIPELINE_SOURCE" = "schedule" ] && [ -f pip-audit-report.json ]; then
        # Count vulnerabilities using python
        VULN_COUNT=$(python3 -c "import json; data=json.load(open('pip-audit-report.json')); print(sum(len(d.get('vulns', [])) for d in data.get('dependencies', [])))")

        if [ "$VULN_COUNT" -gt 0 ]; then
          echo "üö® Found $VULN_COUNT vulnerabilities, creating GitLab issue..."

          # Create issue via GitLab API
          apt-get update && apt-get install -y curl

          ISSUE_TITLE="Security Alert: $VULN_COUNT Vulnerabilities Found in Dependencies"
          ISSUE_DESCRIPTION="**Automated Security Scan Results**%0A%0Aüî¥ Found **$VULN_COUNT** known vulnerabilities in dependencies.%0A%0A**Actions Required:**%0A- Review the [security dashboard](https://sprig-config-7f4835.gitlab.io/)%0A- Check the [detailed report](https://sprig-config-7f4835.gitlab.io/report.html)%0A- Update vulnerable dependencies%0A%0A**Pipeline:** [#${CI_PIPELINE_ID}](${CI_PIPELINE_URL})%0A**Scanned:** $(date -u +'%Y-%m-%d %H:%M:%S UTC')%0A%0A---%0A*This issue was automatically created by the scheduled security scan.*"

          curl --request POST \
            --header "PRIVATE-TOKEN: ${CI_JOB_TOKEN}" \
            --data "title=${ISSUE_TITLE}" \
            --data "description=${ISSUE_DESCRIPTION}" \
            --data "labels=security,automated" \
            "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/issues"

          echo "‚úÖ Issue created successfully"
        else
          echo "‚úÖ No vulnerabilities found, no issue created"
        fi
      fi
  artifacts:
    when: always
    paths:
      - sprig-config-module/pip-audit-report.json
      - sprig-config-module/pip-audit-report.md
    expire_in: 7 days
  rules:
    - if: '$CI_PIPELINE_SOURCE == "schedule"'  # Always run on scheduled pipelines
    - if: '$CI_COMMIT_BRANCH == "main"'
    - if: '$CI_MERGE_REQUEST_IID'
    - if: '$CI_COMMIT_TAG'
    - if: '$CI_COMMIT_BRANCH'
      when: manual
      allow_failure: true

dry_run_pypi:
  stage: deploy
  extends: .default_setup
  rules:
    - if: '$CI_COMMIT_TAG =~ /^[Vv]/'
      when: manual
    - when: never
  script:
    - |
      echo "üîç Verifying version match before dry-run..."
      export PYPROJECT_VERSION=$(poetry version -s)
      echo "üì¶ pyproject.toml version: $PYPROJECT_VERSION"
      echo "üè∑Ô∏è Git tag: ${CI_COMMIT_TAG}"

      # Normalize case and strip leading "v"/"V" for comparison
      TAG_VERSION=$(echo "${CI_COMMIT_TAG}" | sed -E 's/^[Vv]//')
      if [ "${PYPROJECT_VERSION,,}" != "${TAG_VERSION,,}" ]; then
        echo "‚ùå Version mismatch! Expected tag: v${PYPROJECT_VERSION}, got: ${CI_COMMIT_TAG}"
        exit 1
      fi

      echo "‚úÖ Version match confirmed, building package..."
      poetry build
      echo "üß™ Simulating publish (no upload)..."
      poetry publish --dry-run -r gitlab-pypi
  artifacts:
    when: always
    paths:
      - sprig-config-module/dist/
    expire_in: 3 days
  environment:
    name: staging

deploy_pypi:
  stage: deploy
  extends: .default_setup
  needs: ["dry_run_pypi"]
  rules:
    - if: '$CI_COMMIT_TAG =~ /^[Vv]/'
      when: manual
    - when: never
  script:
    - |
      echo "üîç Confirming version consistency before deploy..."
      export PYPROJECT_VERSION=$(poetry version -s)
      echo "üì¶ pyproject.toml version: $PYPROJECT_VERSION"
      echo "üè∑Ô∏è Git tag: ${CI_COMMIT_TAG}"

      # Normalize case and strip leading "v"/"V" for comparison
      TAG_VERSION=$(echo "${CI_COMMIT_TAG}" | sed -E 's/^[Vv]//')
      if [ "${PYPROJECT_VERSION,,}" != "${TAG_VERSION,,}" ]; then
        echo "‚ùå Version mismatch! Expected tag: v${PYPROJECT_VERSION}, got: ${CI_COMMIT_TAG}"
        exit 1
      fi

      echo "üöÄ Publishing tested artifacts to GitLab PyPI..."
      poetry publish --no-interaction -r gitlab-pypi
  dependencies:
    - dry_run_pypi
  artifacts:
    expire_in: 7 days
  environment:
    name: production

# GitLab Pages - Vulnerability Report Dashboard
pages:
  stage: pages
  image: alpine:latest
  needs: ["pip_audit"]
  dependencies:
    - pip_audit
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
    - if: '$CI_PIPELINE_SOURCE == "schedule"'
  script:
    - mkdir -p public
    - |
      # Copy reports
      if [ -f sprig-config-module/pip-audit-report.json ]; then
        echo "‚úì Found pip-audit-report.json, copying to public/"
        cp sprig-config-module/pip-audit-report.json public/
      else
        echo "‚ö† Warning: pip-audit-report.json not found, creating empty report"
        echo '{"dependencies": [], "vulnerabilities": []}' > public/pip-audit-report.json
      fi
      if [ -f sprig-config-module/pip-audit-report.md ]; then
        echo "‚úì Found pip-audit-report.md, copying to public/"
        cp sprig-config-module/pip-audit-report.md public/
      fi
    - |
      # Create index.html dashboard
      cat > public/index.html << 'EOF'
      <!DOCTYPE html>
      <html lang="en">
      <head>
          <meta charset="UTF-8">
          <meta name="viewport" content="width=device-width, initial-scale=1.0">
          <title>SprigConfig Security Dashboard</title>
          <style>
              * { margin: 0; padding: 0; box-sizing: border-box; }
              body {
                  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
                  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                  min-height: 100vh;
                  padding: 2rem;
              }
              .container {
                  max-width: 900px;
                  margin: 0 auto;
                  background: white;
                  border-radius: 12px;
                  box-shadow: 0 20px 60px rgba(0,0,0,0.3);
                  overflow: hidden;
              }
              .header {
                  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                  color: white;
                  padding: 2rem;
                  text-align: center;
              }
              .header h1 { font-size: 2rem; margin-bottom: 0.5rem; }
              .header p { opacity: 0.9; }
              .content { padding: 2rem; }
              .report-card {
                  background: #f8f9fa;
                  border: 2px solid #e9ecef;
                  border-radius: 8px;
                  padding: 1.5rem;
                  margin-bottom: 1rem;
                  transition: all 0.3s ease;
              }
              .report-card:hover {
                  border-color: #667eea;
                  box-shadow: 0 4px 12px rgba(102, 126, 234, 0.15);
                  transform: translateY(-2px);
              }
              .report-card h2 {
                  color: #495057;
                  font-size: 1.25rem;
                  margin-bottom: 0.5rem;
              }
              .report-card p { color: #6c757d; margin-bottom: 1rem; }
              .report-links { display: flex; gap: 0.5rem; flex-wrap: wrap; }
              .btn {
                  display: inline-block;
                  padding: 0.5rem 1rem;
                  background: #667eea;
                  color: white;
                  text-decoration: none;
                  border-radius: 6px;
                  transition: background 0.3s ease;
                  font-weight: 500;
              }
              .btn:hover { background: #764ba2; }
              .btn-secondary {
                  background: #6c757d;
              }
              .btn-secondary:hover { background: #5a6268; }
              .timestamp {
                  text-align: center;
                  color: #6c757d;
                  font-size: 0.875rem;
                  padding: 1rem;
                  border-top: 1px solid #e9ecef;
              }
              .badge {
                  display: inline-block;
                  padding: 0.25rem 0.75rem;
                  background: #28a745;
                  color: white;
                  border-radius: 12px;
                  font-size: 0.75rem;
                  font-weight: 600;
                  margin-left: 0.5rem;
              }
          </style>
      </head>
      <body>
          <div class="container">
              <div class="header">
                  <h1>üõ°Ô∏è SprigConfig Security Dashboard</h1>
                  <p>Automated Vulnerability & Security Scans</p>
              </div>
              <div class="content">
                  <div class="report-card">
                      <h2>üì¶ pip-audit <span class="badge">Dependency Scanner</span></h2>
                      <p>Scans Python dependencies for known security vulnerabilities using the OSV database. These vulnerabilities are already publicly documented in CVE databases.</p>
                      <div class="report-links">
                          <a href="report.html" class="btn">View Report</a>
                          <a href="pip-audit-report.json" class="btn btn-secondary">Download JSON</a>
                      </div>
                  </div>

                  <div class="report-card">
                      <h2>‚ÑπÔ∏è About This Dashboard</h2>
                      <p>This dashboard shows dependency vulnerability scans. All vulnerabilities listed here are already publicly documented in security databases. Additional security scans (SAST, Bandit, Secret Detection) are run in CI but kept private as artifacts.</p>
                  </div>

                  <div class="report-card">
                      <h2>üîó Quick Links</h2>
                      <p>Additional resources and documentation.</p>
                      <div class="report-links">
                          <a href="https://gitlab.com/dgw_software/sprig-config/-/pipelines" class="btn btn-secondary">CI/CD Pipelines</a>
                          <a href="https://pypi.org/project/sprig-config/" class="btn btn-secondary">PyPI Package</a>
                          <a href="https://gitlab.com/dgw_software/sprig-config" class="btn btn-secondary">Source Code</a>
                      </div>
                  </div>
              </div>
              <div class="timestamp">
                  Last updated: <strong>COMMIT_PLACEHOLDER</strong> on <strong>DATE_PLACEHOLDER</strong>
              </div>
          </div>
      </body>
      </html>
      EOF
      # Replace placeholders with actual values
      sed -i "s/COMMIT_PLACEHOLDER/${CI_COMMIT_SHORT_SHA}/" public/index.html
      sed -i "s/DATE_PLACEHOLDER/$(date -u +"%Y-%m-%d %H:%M:%S UTC")/" public/index.html
    - |
      # Create report viewer HTML
      cat > public/report.html << 'EOFHTML'
      <!DOCTYPE html>
      <html lang="en">
      <head>
          <meta charset="UTF-8">
          <meta name="viewport" content="width=device-width, initial-scale=1.0">
          <title>pip-audit Vulnerability Report</title>
          <style>
              * { margin: 0; padding: 0; box-sizing: border-box; }
              body {
                  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
                  background: #f5f5f5;
                  padding: 2rem;
              }
              .container { max-width: 1200px; margin: 0 auto; }
              .header {
                  background: white;
                  padding: 2rem;
                  border-radius: 8px;
                  margin-bottom: 2rem;
                  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
              }
              .header h1 { color: #333; margin-bottom: 0.5rem; }
              .summary {
                  display: grid;
                  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                  gap: 1rem;
                  margin-bottom: 2rem;
              }
              .summary-card {
                  background: white;
                  padding: 1.5rem;
                  border-radius: 8px;
                  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
              }
              .summary-card h3 { color: #666; font-size: 0.875rem; margin-bottom: 0.5rem; text-transform: uppercase; }
              .summary-card .number { font-size: 2rem; font-weight: bold; color: #667eea; }
              .no-vulns {
                  background: #d4edda;
                  color: #155724;
                  padding: 2rem;
                  border-radius: 8px;
                  text-align: center;
                  font-size: 1.125rem;
                  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
              }
              .vuln-card {
                  background: white;
                  padding: 1.5rem;
                  border-radius: 8px;
                  margin-bottom: 1rem;
                  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                  border-left: 4px solid #f44336;
              }
              .vuln-header { display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem; flex-wrap: wrap; gap: 0.5rem; }
              .vuln-title { font-size: 1.25rem; color: #333; font-weight: 600; }
              .vuln-id { font-family: monospace; background: #f5f5f5; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.875rem; }
              .vuln-details { color: #666; line-height: 1.6; }
              .vuln-details p { margin-bottom: 0.75rem; }
              .vuln-details strong { color: #333; }
              .fix-versions { background: #e3f2fd; padding: 0.5rem; border-radius: 4px; font-family: monospace; font-size: 0.875rem; }
              .back-link {
                  display: inline-block;
                  margin-top: 2rem;
                  color: #667eea;
                  text-decoration: none;
                  font-weight: 500;
              }
              .back-link:hover { text-decoration: underline; }
              .loading { text-align: center; padding: 3rem; color: #666; }
          </style>
      </head>
      <body>
          <div class="container">
              <div class="header">
                  <h1>üì¶ pip-audit Vulnerability Report</h1>
                  <p>Python dependency security scan results</p>
              </div>
              <div id="content" class="loading">Loading report...</div>
              <a href="index.html" class="back-link">‚Üê Back to Security Dashboard</a>
          </div>
          <script>
              fetch('pip-audit-report.json')
                  .then(r => r.json())
                  .then(data => {
                      const vulns = data.vulnerabilities || [];
                      const deps = data.dependencies || [];

                      let html = '<div class="summary">';
                      html += '<div class="summary-card"><h3>Total Dependencies</h3><div class="number">' + deps.length + '</div></div>';
                      html += '<div class="summary-card"><h3>Vulnerabilities Found</h3><div class="number" style="color: ' + (vulns.length > 0 ? '#f44336' : '#4caf50') + ';">' + vulns.length + '</div></div>';
                      html += '</div>';

                      if (vulns.length === 0) {
                          html += '<div class="no-vulns">‚úÖ No vulnerabilities found! Your dependencies are secure.</div>';
                      } else {
                          vulns.forEach(v => {
                              html += '<div class="vuln-card">';
                              html += '<div class="vuln-header">';
                              html += '<div class="vuln-title">' + (v.name || 'Unknown') + ' ' + (v.version || '') + '</div>';
                              html += '<div class="vuln-id">' + (v.id || 'N/A') + '</div>';
                              html += '</div>';
                              html += '<div class="vuln-details">';
                              if (v.description) html += '<p>' + v.description + '</p>';
                              if (v.fix_versions && v.fix_versions.length > 0) {
                                  html += '<p><strong>Fix available:</strong></p>';
                                  html += '<div class="fix-versions">Upgrade to: ' + v.fix_versions.join(', ') + '</div>';
                              } else {
                                  html += '<p><strong>Fix:</strong> No fix available yet</p>';
                              }
                              if (v.aliases && v.aliases.length > 0) {
                                  html += '<p><strong>Aliases:</strong> ' + v.aliases.join(', ') + '</p>';
                              }
                              html += '</div></div>';
                          });
                      }

                      document.getElementById('content').innerHTML = html;
                  })
                  .catch(err => {
                      document.getElementById('content').innerHTML = '<div class="no-vulns" style="background: #f8d7da; color: #721c24;">Error loading report: ' + err.message + '</div>';
                  });
          </script>
      </body>
      </html>
      EOFHTML
  artifacts:
    paths:
      - public
    expire_in: 30 days
