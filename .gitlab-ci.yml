# ==========================================
#  GitLab CI for sprig-config
# ==========================================
# Runs lint, tests, security scans, and
# allows a manual publish to GitLab PyPI
# from the main branch.
# ==========================================

stages:
  - lint
  - test
  - security
  - deploy

variables:
  POETRY_VERSION: "2.2.0"
  PIP_NO_CACHE_DIR: "1"
  PIP_DISABLE_PIP_VERSION_CHECK: "1"
  POETRY_NO_INTERACTION: "1"
  POETRY_VIRTUALENVS_CREATE: "true"
  POETRY_VIRTUALENVS_IN_PROJECT: "true"
  PYTHON_KEYRING_BACKEND: "keyring.backends.null.Keyring"
  SECRET_DETECTION_ENABLED: "true"
  SAST_STAGE: security
  SECRET_DETECTION_STAGE: security

# -----------------------
# Base template: setup
# -----------------------
.default_setup:
  image: python:3.13-slim
  before_script:
    - cd sprig-config-module
    - pip install --no-cache-dir "poetry==$POETRY_VERSION"
    - poetry install --no-ansi

workflow:
  rules:
    - if: '$CI_COMMIT_TAG'        # always run pipelines for tags
      when: always
    - if: '$CI_COMMIT_BRANCH'     # and for branches
      when: always

# -----------------------
# 1Ô∏è‚É£ Lint and style checks
# -----------------------
lint:
  stage: lint
  extends: .default_setup
  script:
    - poetry run ruff check src
  artifacts:
    when: always
    paths:
      - sprig-config-module/ruff.log

# -----------------------
# 2Ô∏è‚É£ Unit tests + coverage
# -----------------------
pytest:
  stage: test
  extends: .default_setup
  variables:
    APP_SECRET_KEY: "Y1PvJOeB_Dhak0oNJecfKRaKb4VcvmTwlFUo8-gVr7Q="  # Key for test only
  script:
    - poetry run pytest --maxfail=1 --disable-warnings -q --cov=src --cov-report=xml
  artifacts:
    when: always
    reports:
      junit: sprig-config-module/reports/junit.xml
      coverage_report:
        coverage_format: cobertura
        path: sprig-config-module/coverage.xml
    paths:
      - sprig-config-module/reports/
      - sprig-config-module/coverage.xml

# -----------------------
# 3Ô∏è‚É£ Security Scanning
# -----------------------
include:
  - template: Security/SAST.gitlab-ci.yml
  - template: Security/Secret-Detection.gitlab-ci.yml

sast:
  stage: security

secret_detection:
  stage: security

bandit:
  stage: security
  extends: .default_setup
  script:
    - poetry run bandit -r src -f json -o gl-bandit-report.json || true
  allow_failure: true
  artifacts:
    when: always
    reports:
      sast: sprig-config-module/gl-bandit-report.json

# -----------------------
# 4Ô∏è‚É£ Dry Run
# -----------------------
dry_run_pypi:
  stage: deploy
  extends: .default_setup
  rules:
    - if: '$CI_COMMIT_TAG =~ /^[Vv]/'
      when: manual
    - when: never
  script:
    - |
      echo "üîç Verifying version match before dry-run..."
      export PYPROJECT_VERSION=$(poetry version -s)
      echo "üì¶ pyproject.toml version: $PYPROJECT_VERSION"
      echo "üè∑Ô∏è Git tag: ${CI_COMMIT_TAG}"

      # Normalize case and strip leading "v"/"V" for comparison
      TAG_VERSION=$(echo "${CI_COMMIT_TAG}" | sed -E 's/^[Vv]//')
      if [ "${PYPROJECT_VERSION,,}" != "${TAG_VERSION,,}" ]; then
        echo "‚ùå Version mismatch! Expected tag: v${PYPROJECT_VERSION}, got: ${CI_COMMIT_TAG}"
        exit 1
      fi

      echo "‚úÖ Version match confirmed, building package..."
      poetry build
      echo "üß™ Simulating publish (no upload)..."
      poetry publish --dry-run -r gitlab-pypi
  artifacts:
    when: always
    paths:
      - sprig-config-module/dist/
    expire_in: 3 days
  environment:
    name: staging

# -----------------------
# 5Ô∏è‚É£ Deploy to GitLab PyPI
# -----------------------
deploy_pypi:
  stage: deploy
  extends: .default_setup
  needs: ["dry_run_pypi"]
  rules:
    - if: '$CI_COMMIT_TAG =~ /^[Vv]/'
      when: manual
    - when: never
  script:
    - |
      echo "üîç Confirming version consistency before deploy..."
      export PYPROJECT_VERSION=$(poetry version -s)
      echo "üì¶ pyproject.toml version: $PYPROJECT_VERSION"
      echo "üè∑Ô∏è Git tag: ${CI_COMMIT_TAG}"

      # Normalize case and strip leading "v"/"V" for comparison
      TAG_VERSION=$(echo "${CI_COMMIT_TAG}" | sed -E 's/^[Vv]//')
      if [ "${PYPROJECT_VERSION,,}" != "${TAG_VERSION,,}" ]; then
        echo "‚ùå Version mismatch! Expected tag: v${PYPROJECT_VERSION}, got: ${CI_COMMIT_TAG}"
        exit 1
      fi

      echo "üöÄ Publishing tested artifacts to GitLab PyPI..."
      poetry publish --no-interaction -r gitlab-pypi
  dependencies:
    - dry_run_pypi
  artifacts:
    expire_in: 7 days
  environment:
    name: production
