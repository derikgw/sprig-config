# ==========================================
#  GitLab CI for sprig-config
# ==========================================
# Runs lint, tests, security scans, and
# allows a manual publish to GitLab PyPI
# from the main branch.
# ==========================================

stages:
  - lint
  - test
  - security
  - deploy

variables:
  POETRY_VERSION: "2.2.0"
  PIP_NO_CACHE_DIR: "1"
  PIP_DISABLE_PIP_VERSION_CHECK: "1"
  POETRY_NO_INTERACTION: "1"
  POETRY_VIRTUALENVS_CREATE: "true"
  POETRY_VIRTUALENVS_IN_PROJECT: "true"
  PYTHON_KEYRING_BACKEND: "keyring.backends.null.Keyring"
  SECRET_DETECTION_ENABLED: "true"
  SAST_STAGE: security
  SECRET_DETECTION_STAGE: security

# -----------------------
# Base template: setup
# -----------------------
.default_setup:
  image: python:3.13-slim
  before_script:
    - cd sprig-config-module
    - pip install --no-cache-dir "poetry==$POETRY_VERSION"
    - poetry install --no-ansi

# -----------------------
# 1Ô∏è‚É£ Lint and style checks
# -----------------------
lint:
  stage: lint
  extends: .default_setup
  script:
    - poetry run ruff check src
  artifacts:
    when: always
    paths:
      - sprig-config-module/ruff.log

# -----------------------
# 2Ô∏è‚É£ Unit tests + coverage
# -----------------------
pytest:
  stage: test
  extends: .default_setup
  variables:
    # Key for test only
    APP_SECRET_KEY: "Y1PvJOeB_Dhak0oNJecfKRaKb4VcvmTwlFUo8-gVr7Q="
  script:
    - poetry run pytest --maxfail=1 --disable-warnings -q --cov=src --cov-report=xml
  artifacts:
    when: always
    reports:
      junit: sprig-config-module/reports/junit.xml
      coverage_report:
        coverage_format: cobertura
        path: sprig-config-module/coverage.xml
    paths:
      - sprig-config-module/reports/
      - sprig-config-module/coverage.xml

# -----------------------
# 3Ô∏è‚É£ Security Scanning
# -----------------------
include:
  - template: Security/SAST.gitlab-ci.yml
  - template: Security/Secret-Detection.gitlab-ci.yml

sast:
  stage: security

secret_detection:
  stage: security

bandit:
  stage: security
  extends: .default_setup
  script:
    - poetry run bandit -r src -f json -o gl-bandit-report.json || true
  allow_failure: true
  artifacts:
    when: always
    reports:
      sast: sprig-config-module/gl-bandit-report.json

# -----------------------
# 4Ô∏è‚É£ Deploy to GitLab PyPI
# -----------------------
deploy_pypi:
  stage: deploy
  image: python:3.13-slim
  only:
    - main
  when: manual
  variables:
    POETRY_HTTP_BASIC_GITLAB_PYPI_USERNAME: "__token__"
    POETRY_HTTP_BASIC_GITLAB_PYPI_PASSWORD: "${CI_JOB_TOKEN}"
  script:
    - echo "üîπ Building package for PyPI..."
    - poetry build
    - echo "üîπ Publishing to GitLab PyPI registry..."
    - poetry publish -r gitlab-pypi
  environment:
    name: production
